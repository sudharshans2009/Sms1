// Prisma Schema for Amrita Vidyalayam SMS
// Uses Neon PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Users and Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  student   Student?
  teacher   Teacher?
  driver    Driver?

  @@index([email])
  @@index([role])
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
  DRIVER
}

// Students
model Student {
  id           String    @id @default(cuid())
  userId       String?   @unique
  user         User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  studentId    String    @unique // e.g., AV001
  name         String
  class        String
  section      String
  rollNumber   String?
  dateOfBirth  DateTime?
  gender       String?
  parentName   String?
  parentPhone  String
  parentEmail  String
  address      String?
  bloodGroup   String?
  studentPhone String?
  studentEmail String?
  busId        String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  bus          Bus?             @relation(fields: [busId], references: [id])
  attendance   Attendance[]
  marks        Marks[]
  borrowedBooks BorrowedBook[]
  feePayments  FeePayment[]
  medical      StudentMedical?
  academic     StudentAcademic[]
  examResults  ExamResult[]

  @@index([studentId])
  @@index([class, section])
  @@index([busId])
}

// Teachers
model Teacher {
  id            String   @id @default(cuid())
  userId        String?  @unique
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  teacherId     String   @unique // e.g., T001
  name          String
  subject       String?
  qualification String?
  experience    String?
  phone         String?
  email         String?  @unique
  address       String?
  joiningDate   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  classes       Class[]

  @@index([teacherId])
  @@index([email])
}

// Drivers
model Driver {
  id          String   @id @default(cuid())
  userId      String?  @unique
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  driverId    String   @unique
  name        String
  phone       String
  license     String   @unique
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  buses       Bus[]

  @@index([driverId])
}

// Buses
model Bus {
  id              String    @id @default(cuid())
  busId           String    @unique // e.g., AV01
  driverName      String
  driverId        String?
  route           String
  currentLat      Float     @default(10.9027)
  currentLng      Float     @default(76.9015)
  speed           Int       @default(0)
  status          BusStatus @default(INACTIVE)
  lastUpdate      DateTime  @default(now())
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  driver          Driver?      @relation(fields: [driverId], references: [id])
  students        Student[]
  issues          BusIssue[]
  location        BusLocation?

  @@index([busId])
  @@index([driverId])
  @@index([status])
}

enum BusStatus {
  ACTIVE
  INACTIVE
}

// Classes
model Class {
  id            String   @id @default(cuid())
  class         String
  section       String
  classTeacher  String
  teacherId     String?
  room          String?
  capacity      Int?
  studentsCount Int      @default(0)
  classHead     String
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  teacher       Teacher?      @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  timetable     Timetable?
  announcements Announcement[]

  @@unique([class, section])
  @@index([class, section])
  @@index([teacherId])
}

// Timetable
model Timetable {
  id          String   @id @default(cuid())
  classId     String   @unique
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  schedule    String   // Stores the complete schedule as JSON string
  lastUpdated DateTime @default(now())
  updatedBy   String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([classId])
}

// Attendance
model Attendance {
  id        String           @id @default(cuid())
  studentId String
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  date      DateTime
  status    AttendanceStatus
  class     String
  section   String
  
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([studentId, date])
  @@index([studentId])
  @@index([date])
  @@index([class, section])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  LEAVE
}

// Marks
model Marks {
  id         String   @id @default(cuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  class      String
  section    String
  examType   String
  subjects   String   // Stores subject-wise marks as JSON string
  total      Int
  grade      String
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([studentId])
  @@index([class, section])
  @@index([examType])
}

// Announcements
model Announcement {
  id        String             @id @default(cuid())
  title     String
  content   String
  priority  AnnouncementPriority @default(NORMAL)
  target    AnnouncementTarget   @default(ALL)
  classId   String?
  class     Class?             @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([priority])
  @@index([target])
  @@index([createdAt])
}

enum AnnouncementPriority {
  NORMAL
  IMPORTANT
  URGENT
}

enum AnnouncementTarget {
  ALL
  STUDENTS
  TEACHERS
  PARENTS
}

// Library Management (Enhanced)
model Book {
  id          String   @id @default(cuid())
  bookId      String   @unique // e.g., B001
  title       String
  author      String
  isbn        String   @unique
  category    String
  publisher   String
  year        Int
  edition     String?
  language    String   @default("English")
  pages       Int?
  price       Float?
  quantity    Int      @default(1)
  available   Int      @default(1)
  location    String
  description String?
  coverImage  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  borrowedBooks BorrowedBook[]

  @@index([bookId])
  @@index([isbn])
  @@index([category])
  @@index([title])
  @@index([author])
}

// Borrowed Books
model BorrowedBook {
  id          String   @id @default(cuid())
  bookId      String
  book        Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  borrowDate  DateTime @default(now())
  dueDate     DateTime
  returnDate  DateTime?
  status      BorrowStatus @default(BORROWED)
  fine        Float    @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([bookId])
  @@index([studentId])
  @@index([status])
  @@index([borrowDate])
  @@index([dueDate])
}

enum BorrowStatus {
  BORROWED
  RETURNED
  OVERDUE
  LOST
}

// Library Categories
model BookCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

// Messages
// Advanced Messaging System
model Message {
  id              String          @id @default(cuid())
  subject         String
  content         String
  
  // Sender Information
  senderId        String
  senderName      String
  senderRole      Role
  
  // Receiver Information
  receiverId      String
  receiverName    String
  receiverRole    Role
  
  // Message Properties
  priority        MessagePriority @default(NORMAL)
  category        MessageCategory @default(GENERAL)
  isRead          Boolean         @default(false)
  readAt          DateTime?
  isStarred       Boolean         @default(false)
  isArchived      Boolean         @default(false)
  isDraft         Boolean         @default(false)
  
  // Threading
  threadId        String?
  replyToId       String?
  replyTo         Message?        @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies         Message[]       @relation("MessageReplies")
  
  // Attachments
  attachments     MessageAttachment[]
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  scheduledFor    DateTime?
  
  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([isStarred])
  @@index([isArchived])
  @@index([isDraft])
  @@index([threadId])
  @@index([priority])
  @@index([category])
  @@index([createdAt])
  @@index([scheduledFor])
}

enum MessagePriority {
  LOW
  NORMAL
  IMPORTANT
  HIGH
  URGENT
}

enum MessageCategory {
  GENERAL
  ACADEMIC
  ADMINISTRATIVE
  ATTENDANCE
  FEES
  EVENT
  EMERGENCY
}

model MessageAttachment {
  id          String   @id @default(cuid())
  messageId   String
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  fileName    String
  fileType    String
  fileSize    Int
  fileUrl     String
  
  createdAt   DateTime @default(now())
  
  @@index([messageId])
}

// Message Templates for quick replies
model MessageTemplate {
  id          String          @id @default(cuid())
  name        String
  subject     String
  content     String
  category    MessageCategory @default(GENERAL)
  role        Role            // Which role can use this template
  isActive    Boolean         @default(true)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([role])
  @@index([category])
}

// Broadcast Messages for sending to multiple users
model BroadcastMessage {
  id              String          @id @default(cuid())
  subject         String
  content         String
  
  senderId        String
  senderName      String
  senderRole      Role
  
  targetRole      Role?           // Send to all users of this role
  targetClass     String?         // Send to specific class
  targetSection   String?         // Send to specific section
  
  priority        MessagePriority @default(NORMAL)
  category        MessageCategory @default(GENERAL)
  
  sentCount       Int             @default(0)
  readCount       Int             @default(0)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  scheduledFor    DateTime?
  sentAt          DateTime?
  
  @@index([senderId])
  @@index([targetRole])
  @@index([targetClass, targetSection])
  @@index([createdAt])
  @@index([scheduledFor])
}

// Advanced Fee Management System
model FeeStructure {
  id              String   @id @default(cuid())
  class           String
  section         String?
  academicYear    String   // e.g., "2024-2025"
  
  // Fee Components (all in INR)
  tuitionFee      Float    @default(0)
  admissionFee    Float    @default(0)
  examFee         Float    @default(0)
  libraryFee      Float    @default(0)
  sportsFee       Float    @default(0)
  labFee          Float    @default(0)
  busFee          Float    @default(0)
  uniformFee      Float    @default(0)
  otherFee        Float    @default(0)
  
  // Total and Payment Terms
  totalFee        Float
  installments    Int      @default(3) // Number of installments
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  feePayments     FeePayment[]
  
  @@unique([class, section, academicYear])
  @@index([class, section])
  @@index([academicYear])
  @@index([isActive])
}

model FeePayment {
  id              String         @id @default(cuid())
  studentId       String
  student         Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  feeStructureId  String
  feeStructure    FeeStructure   @relation(fields: [feeStructureId], references: [id])
  
  academicYear    String
  term            String         // Term1, Term2, Term3, Annual
  
  // Payment Details
  amountDue       Float
  amountPaid      Float          @default(0)
  amountPending   Float
  fine            Float          @default(0)
  discount        Float          @default(0)
  
  // Payment Info
  paymentMethod   PaymentMethod?
  transactionId   String?
  receiptNumber   String?        @unique
  
  // Status
  status          PaymentStatus  @default(PENDING)
  dueDate         DateTime
  paidDate        DateTime?
  
  // Additional Info
  remarks         String?        // Remarks
  paidBy          String?        // Parent/Guardian name
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([studentId])
  @@index([feeStructureId])
  @@index([status])
  @@index([academicYear])
  @@index([dueDate])
  @@index([paidDate])
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  WAIVED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  NET_BANKING
  CHEQUE
  DEMAND_DRAFT
}

// Bus Issue Reporting System
model BusIssue {
  id              String         @id @default(cuid())
  busId           String
  bus             Bus            @relation(fields: [busId], references: [id], onDelete: Cascade)
  
  reportedBy      String         // Driver ID
  reportedByName  String
  
  // Issue Details
  issueType       BusIssueType
  severity        IssueSeverity  @default(MEDIUM)
  title           String
  description     String
  location        String?
  
  // Visibility
  visibleTo       IssueVisibility @default(ADMIN_ONLY)
  
  // Status
  status          IssueStatus    @default(REPORTED)
  resolvedBy      String?
  resolvedAt      DateTime?
  resolution      String?
  
  // Attachments
  photos          String?        // JSON string array of image URLs
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([busId])
  @@index([reportedBy])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

enum BusIssueType {
  MECHANICAL
  ACCIDENT
  BREAKDOWN
  MAINTENANCE
  CLEANLINESS
  SAFETY
  ROUTE_CHANGE
  DELAY
  OTHER
}

enum IssueSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IssueStatus {
  REPORTED
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssueVisibility {
  STUDENTS_ONLY
  ADMIN_ONLY
  BOTH
}

// Live Location Tracking
model BusLocation {
  id          String   @id @default(cuid())
  busId       String   @unique
  bus         Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  
  latitude    Float
  longitude   Float
  speed       Float    @default(0)
  heading     Float?   // Direction in degrees
  accuracy    Float?   // Accuracy in meters
  
  // Status
  isSharing   Boolean  @default(false)
  lastUpdated DateTime @default(now())
  
  // Driver Info
  driverId    String
  driverName  String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([busId])
  @@index([lastUpdated])
}

// Student Medical Records
model StudentMedical {
  id              String    @id @default(cuid())
  studentId       String    @unique
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Medical Info
  bloodGroup      String?
  height          Float?    // in cm
  weight          Float?    // in kg
  
  // Health Issues
  allergies       String?  // JSON string array of allergies
  chronicIllness  String?  // JSON string array of chronic conditions
  disabilities    String?
  
  // Medications
  currentMedications String? // JSON string array of current medications
  pastSurgeries   String?   // JSON string array of past surgeries
  
  // Emergency
  emergencyContact String
  emergencyPhone   String
  emergencyRelation String
  
  // Medical History
  vaccinations    String?   // JSON string array of vaccinations
  lastCheckup     DateTime?
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([studentId])
  @@index([bloodGroup])
}

// Student Academic Performance
model StudentAcademic {
  id              String   @id @default(cuid())
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  academicYear    String
  term            String   // Term1, Term2, Term3, Annual
  
  // Marks by Subject (JSON string)
  subjects        String   // JSON string: { "Math": 95, "Science": 88, ... }
  totalMarks      Float
  maxMarks        Float
  percentage      Float
  grade           String
  rank            Int?
  
  // Attendance
  totalDays       Int
  presentDays     Int
  absentDays      Int
  attendancePercentage Float
  
  // Status
  studyStatus     StudyStatus @default(REGULAR)
  promoted        Boolean  @default(false)
  
  // Remarks
  teacherRemarks  String?
  principalRemarks String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([studentId, academicYear, term])
  @@index([studentId])
  @@index([academicYear])
  @@index([percentage])
  @@index([grade])
}

enum StudyStatus {
  REGULAR
  DETAINED
  PROMOTED
  FAILED
  DROPOUT
  TRANSFERRED
}

// Academic Calendar System
model AcademicYear {
  id              String   @id @default(cuid())
  year            String   @unique // e.g., "2024-2025"
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(false)
  description     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  events          AcademicEvent[]
  terms           AcademicTerm[]
  holidays        Holiday[]
  
  @@index([year])
  @@index([isActive])
}

model AcademicTerm {
  id              String       @id @default(cuid())
  academicYearId  String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  
  name            String       // Term 1, Term 2, Term 3, Annual
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean      @default(false)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  // Relations
  events          AcademicEvent[]
  exams           Exam[]
  
  @@index([academicYearId])
  @@index([name])
}

model AcademicEvent {
  id              String        @id @default(cuid())
  title           String
  description     String?
  eventType       EventType
  startDate       DateTime
  endDate         DateTime?
  isAllDay        Boolean       @default(false)
  location        String?
  
  // Academic Relations
  academicYearId  String?
  academicYear    AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  termId          String?
  term            AcademicTerm? @relation(fields: [termId], references: [id], onDelete: SetNull)
  
  // Target Audience
  targetRole      Role?         // Who can see this event
  targetClass     String?       // Specific class
  targetSection   String?       // Specific section
  isPublic        Boolean       @default(true)
  
  // Event Properties
  priority        EventPriority @default(NORMAL)
  color           String        @default("#3b82f6") // Hex color
  isRecurring     Boolean       @default(false)
  recurrenceRule  String?       // RRULE format
  
  // Metadata
  createdBy       String
  createdByName   String
  createdByRole   Role
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  attendees       EventAttendee[]
  reminders       EventReminder[]
  
  @@index([eventType])
  @@index([startDate])
  @@index([academicYearId])
  @@index([targetRole])
  @@index([targetClass, targetSection])
}

enum EventType {
  EXAM
  ASSIGNMENT
  HOLIDAY
  MEETING
  SPORTS
  CULTURAL
  ACADEMIC
  ADMINISTRATIVE
  PARENT_TEACHER
  WORKSHOP
  FIELD_TRIP
  ADMISSION
  RESULT
  ORIENTATION
  GRADUATION
  OTHER
}

enum EventPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Holiday {
  id              String       @id @default(cuid())
  name            String
  date            DateTime
  description     String?
  type            HolidayType  @default(NATIONAL)
  isOptional      Boolean      @default(false)
  
  academicYearId  String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([date])
  @@index([academicYearId])
  @@index([type])
}

enum HolidayType {
  NATIONAL
  REGIONAL
  SCHOOL
  RELIGIOUS
  CULTURAL
  SPORTS
}

model Exam {
  id              String       @id @default(cuid())
  name            String       // Mid-term, Final, Unit Test
  description     String?
  examType        ExamType
  
  startDate       DateTime
  endDate         DateTime
  
  // Academic Relations
  termId          String
  term            AcademicTerm @relation(fields: [termId], references: [id], onDelete: Cascade)
  class           String
  section         String?
  
  // Exam Configuration
  maxMarks        Int          @default(100)
  passingMarks    Int          @default(35)
  duration        Int          // in minutes
  instructions    String?
  
  // Status
  isPublished     Boolean      @default(false)
  isCompleted     Boolean      @default(false)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  // Relations
  subjects        ExamSubject[]
  results         ExamResult[]
  schedule        ExamSchedule[]
  
  @@index([termId])
  @@index([class, section])
  @@index([examType])
  @@index([startDate])
}

enum ExamType {
  UNIT_TEST
  MID_TERM
  FINAL_TERM
  QUARTERLY
  HALF_YEARLY
  ANNUAL
  ENTRANCE
  COMPETITIVE
  INTERNAL_ASSESSMENT
  PRACTICAL
  PROJECT
}

model ExamSubject {
  id              String   @id @default(cuid())
  examId          String
  exam            Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  subject         String
  maxMarks        Int      @default(100)
  passingMarks    Int      @default(35)
  duration        Int      // in minutes
  date            DateTime?
  startTime       String?  // e.g., "09:00"
  endTime         String?  // e.g., "12:00"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([examId])
  @@index([subject])
}

model ExamResult {
  id              String   @id @default(cuid())
  examId          String
  exam            Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  subject         String
  marksObtained   Float
  maxMarks        Int
  grade           String?
  remarks         String?
  
  isAbsent        Boolean  @default(false)
  isPass          Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([examId, studentId, subject])
  @@index([examId])
  @@index([studentId])
  @@index([subject])
}

model ExamSchedule {
  id              String   @id @default(cuid())
  examId          String
  exam            Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  subject         String
  date            DateTime
  startTime       String   // e.g., "09:00"
  endTime         String   // e.g., "12:00"
  room            String?
  invigilator     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([examId])
  @@index([date])
  @@index([subject])
}

model EventAttendee {
  id              String        @id @default(cuid())
  eventId         String
  event           AcademicEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId          String
  userName        String
  userRole        Role
  
  status          AttendeeStatus @default(INVITED)
  responseDate    DateTime?
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

enum AttendeeStatus {
  INVITED
  ACCEPTED
  DECLINED
  TENTATIVE
  NO_RESPONSE
}

model EventReminder {
  id              String        @id @default(cuid())
  eventId         String
  event           AcademicEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId          String
  reminderTime    Int           // minutes before event
  isEmailSent     Boolean       @default(false)
  isSMSSent       Boolean       @default(false)
  isRead          Boolean       @default(false)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([eventId])
  @@index([userId])
}
